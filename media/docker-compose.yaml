version: "3"

services:
  navidrome:
    container_name: navidrome
    image: deluan/navidrome:0.47.0
    depends_on:
      - bonob
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.navidrome.rule=Host(`navidrome.magpie.local`)"
      - "traefik.http.services.navidrome.loadbalancer.server.port=4533"
    user: 1000:1000
    ports:
      - "4533:4533"
    volumes:
      - "${HOME}/navidrome/data:/data"
      - "${HOME}/music:/music:ro"
    networks:
      - traefik_net
    restart: unless-stopped

  bonob:
    container_name: bonob
    image: simojenki/bonob:v0.6.1
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.bonob.rule=Host(`bonob.magpie.local`)"
      - "traefik.http.services.bonob.loadbalancer.server.port=4534"
    environment:
      BNB_URL: "http://bonob.magpie.local"
      BNB_SONOS_AUTO_REGISTER: "true"
      BNB_SONOS_DEVICE_DISCOVERY: "true"
      BNB_SONOS_SEED_HOST: "${SONOS_IP}"
      BNB_SUBSONIC_URL: "http://navidrome.magpie.local"
      TZ: "${TZ}"
    extra_hosts:
      - "navidrome.magpie.local:${HOST_IP}"
    ports:
      - "4534:4534"
    networks:
      - traefik_net
    restart: unless-stopped

  nfs-server:
    container_name: nfs-server
    build: ./nfs-server
    image: nfs-server
    cap_add:
      - SYS_ADMIN
      - SYS_MODULE
    environment:
      NFS_DISABLE_VERSION_3: 1
    ports:
      - 2049:2049
    volumes:
      - "/lib/modules:/lib/modules:ro"
      - "./nfs-server/exports.txt:/etc/exports:ro"
      - "${HOME}/music:/music"
    networks:
      - traefik_net
    restart: unless-stopped

networks:
  traefik_net:
    external: true
